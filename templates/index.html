<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PT â†’ RKNN å¤šæ¨¡å‹è½¬æ¢å·¥å…·</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Microsoft YaHei',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
.container{max-width:900px;margin:0 auto}
.header{text-align:center;color:white;padding:28px 0 20px}
.header h1{font-size:1.9em;margin-bottom:8px}
.header p{opacity:.85}
.steps{display:flex;justify-content:center;margin-bottom:20px}
.step-item{display:flex;align-items:center;gap:7px;color:rgba(255,255,255,.55);font-size:.88em}
.step-item.active{color:#fff;font-weight:700}
.step-item.done{color:rgba(255,255,255,.8)}
.step-num{width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8em}
.step-item.active .step-num{background:#fff;color:#667eea}
.step-item.done .step-num{background:#4caf50;color:#fff}
.step-sep{width:36px;height:2px;background:rgba(255,255,255,.2);margin:0 5px;align-self:center}
.step-sep.done{background:rgba(255,255,255,.6)}
.card{background:#fff;border-radius:14px;padding:24px;margin-bottom:18px;box-shadow:0 4px 20px rgba(0,0,0,.10)}
.card-title{font-size:1.05em;font-weight:700;color:#333;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.step-badge{background:#667eea;color:#fff;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.78em;font-weight:700;flex-shrink:0}
.model-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media(max-width:600px){.model-grid{grid-template-columns:repeat(2,1fr)}}
.mc{border:2px solid #e8e8e8;border-radius:10px;padding:13px 11px;cursor:pointer;transition:all .2s;position:relative}
.mc:hover{border-color:#667eea;background:#f8f9ff}
.mc.sel{border-color:#667eea;background:linear-gradient(135deg,#f0f2ff,#f8f9ff);box-shadow:0 0 0 3px rgba(102,126,234,.13)}
.mc .mci{font-size:1.5em;margin-bottom:5px}
.mc .mcn{font-weight:700;font-size:.88em;color:#333;margin-bottom:2px}
.mc .mcd{font-size:.75em;color:#999;line-height:1.3}
.mc .mcb{font-size:.7em;padding:2px 6px;border-radius:20px;background:#eee;color:#777;margin-top:6px;display:inline-block}
.mc.sel .mcb{background:#e0e5ff;color:#667eea}
.mc .ck{position:absolute;top:7px;right:7px;width:18px;height:18px;border-radius:50%;background:#667eea;color:#fff;display:none;align-items:center;justify-content:center;font-size:.72em}
.mc.sel .ck{display:flex}
.upload-hint{background:#f0f4ff;border-left:4px solid #667eea;padding:9px 13px;border-radius:0 6px 6px 0;font-size:.85em;color:#555;margin-bottom:12px}
.file-drop{border:2px dashed #c5cff5;border-radius:10px;padding:28px 16px;text-align:center;cursor:pointer;transition:all .2s;background:#fafbff}
.file-drop:hover,.file-drop.dragover{border-color:#667eea;background:#f0f2ff}
.file-drop.has-file{border-style:solid;border-color:#667eea}
.file-drop input[type=file]{display:none}
.drop-icon{font-size:2em;margin-bottom:8px}
.drop-main{font-size:.93em;color:#555}
.drop-sub{font-size:.8em;color:#aaa;margin-top:3px}
.vst{margin-top:10px;padding:9px 13px;border-radius:8px;font-size:.86em;display:none}
.vst.checking{background:#fff8e1;color:#856404;display:block}
.vst.ok{background:#d4edda;color:#155724;display:block}
.vst.err{background:#f8d7da;color:#721c24;display:block;white-space:pre-wrap}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.fg{margin-bottom:14px}
.fg label{display:block;font-weight:600;font-size:.85em;color:#444;margin-bottom:5px}
select,input[type=number],input[type=text]{width:100%;padding:9px 11px;border:2px solid #e0e0e0;border-radius:8px;font-size:.92em;outline:none;transition:border-color .2s;background:#fff}
select:focus,input:focus{border-color:#667eea}
/* calibration panel */
.calib-panel{border:2px solid #e8e8e8;border-radius:10px;padding:16px;margin-bottom:16px;transition:all .3s}
.calib-panel.ready{border-color:#28a745;background:#f0fff4}
.calib-panel.missing{border-color:#ff9800;background:#fffbf0}
.calib-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;cursor:pointer}
.calib-badge{font-size:.78em;padding:3px 10px;border-radius:20px;font-weight:600}
.calib-badge.ready{background:#d4edda;color:#155724}
.calib-badge.missing{background:#fff3cd;color:#856404}
.calib-body{font-size:.88em;color:#555}
.calib-input-row{display:flex;gap:8px;margin-top:10px;align-items:flex-start}
.calib-input-row input{flex:1}
.calib-detect-btn{padding:9px 16px;border:none;border-radius:8px;background:#667eea;color:#fff;cursor:pointer;font-size:.88em;white-space:nowrap;transition:opacity .2s}
.calib-detect-btn:hover{opacity:.87}
.calib-detect-btn:disabled{background:#bbb;cursor:not-allowed}
.calib-confirm-btn{padding:9px 16px;border:none;border-radius:8px;background:#28a745;color:#fff;cursor:pointer;font-size:.88em;white-space:nowrap;transition:opacity .2s}
.calib-confirm-btn:hover{opacity:.87}
.calib-confirm-btn:disabled{background:#bbb;cursor:not-allowed}
.calib-status{margin-top:10px;padding:8px 12px;border-radius:6px;font-size:.84em;display:none}
.calib-status.show{display:block}
.calib-status.ok{background:#d4edda;color:#155724}
.calib-status.err{background:#f8d7da;color:#721c24}
.calib-status.info{background:#e3f2fd;color:#0d47a1}
.calib-help{font-size:.8em;color:#aaa;margin-top:6px;line-height:1.4}
.btn{width:100%;padding:13px;border:none;border-radius:10px;font-size:1em;font-weight:700;cursor:pointer;transition:all .2s}
.btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
.btn-primary:hover{opacity:.9;transform:translateY(-1px)}
.btn-primary:disabled{background:#bbb;cursor:not-allowed;transform:none}
.prog{height:5px;background:#f0f0f0;border-radius:3px;overflow:hidden;margin-bottom:14px;display:none}
.prog.active{display:block}
.prog-bar{height:100%;width:0%;background:linear-gradient(90deg,#667eea,#764ba2);border-radius:3px;animation:panim 2.5s ease-in-out infinite}
@keyframes panim{0%{width:5%}50%{width:75%}100%{width:92%}}
.rmsg{padding:14px 16px;border-radius:10px;font-size:.9em;line-height:1.6;display:none;margin-bottom:14px}
.rmsg.show{display:block}
.rmsg.success{background:#d4edda;color:#155724;border-left:4px solid #28a745}
.rmsg.error{background:#f8d7da;color:#721c24;border-left:4px solid #dc3545}
.abtn{display:flex;gap:9px;flex-wrap:wrap;margin-bottom:14px;display:none}
.abtn.show{display:flex}
.dlb{padding:8px 18px;border-radius:8px;font-size:.87em;font-weight:600;text-decoration:none;border:none;cursor:pointer;transition:opacity .2s}
.dlb:hover{opacity:.85}
.dlb.green{background:#28a745;color:#fff}
.dlb.purple{background:#667eea;color:#fff}
.dlb:disabled{background:#bbb;cursor:not-allowed}
.hist-item{display:flex;justify-content:space-between;align-items:center;padding:11px 13px;border:1px solid #eee;border-radius:8px;margin-bottom:7px;transition:all .2s}
.hist-item:hover{background:#f8f9ff;border-color:#c5cff5}
.hist-name{font-weight:600;font-size:.88em;color:#333;margin-bottom:2px}
.hist-meta{font-size:.76em;color:#aaa}
.hist-acts{display:flex;gap:7px;flex-shrink:0}
.sp{display:inline-block;width:16px;height:16px;border:2.5px solid rgba(255,255,255,.35);border-radius:50%;border-top-color:#fff;animation:spin .8s linear infinite;vertical-align:middle;margin-right:5px}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="container">
<div class="header">
  <h1>ğŸš€ PT â†’ RKNN å¤šæ¨¡å‹è½¬æ¢å·¥å…·</h1>
  <p>æ”¯æŒ YOLOv8-Det / Seg / Pose / OBB &nbsp;Â·&nbsp; ResNet &nbsp;Â·&nbsp; RetinaFace</p>
</div>
<div class="steps">
  <div class="step-item active" id="st1"><div class="step-num">1</div><span>é€‰æ‹©ç±»å‹</span></div>
  <div class="step-sep" id="sep1"></div>
  <div class="step-item" id="st2"><div class="step-num">2</div><span>ä¸Šä¼ æ¨¡å‹</span></div>
  <div class="step-sep" id="sep2"></div>
  <div class="step-item" id="st3"><div class="step-num">3</div><span>é…ç½® &amp; è½¬æ¢</span></div>
</div>

<!-- Step 1 -->
<div class="card" id="cardStep1">
  <div class="card-title"><div class="step-badge">1</div>é€‰æ‹©ç½‘ç»œç±»å‹</div>
  <div class="model-grid" id="modelGrid"></div>
</div>

<!-- Step 2 -->
<div class="card" id="cardStep2" style="opacity:.45;pointer-events:none">
  <div class="card-title"><div class="step-badge">2</div>ä¸Šä¼ æ¨¡å‹æ–‡ä»¶</div>
  <div class="upload-hint" id="uploadHint">è¯·å…ˆåœ¨ä¸Šæ–¹é€‰æ‹©ç½‘ç»œç±»å‹</div>
  <div class="file-drop" id="fileDrop">
    <input type="file" id="fileInput" accept=".pt,.pth,.onnx">
    <div class="drop-icon" id="dropIcon">ğŸ“</div>
    <div class="drop-main" id="dropMain">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½æ¨¡å‹æ–‡ä»¶</div>
    <div class="drop-sub" id="dropSub">æ”¯æŒ .pt / .pth / .onnx</div>
  </div>
  <div class="vst" id="vst"></div>
</div>

<!-- Step 3 -->
<div class="card" id="cardStep3" style="opacity:.45;pointer-events:none">
  <div class="card-title"><div class="step-badge">3</div>é…ç½®å‚æ•° &amp; å¼€å§‹è½¬æ¢</div>

  <div class="form-row">
    <div class="fg">
      <label>ç›®æ ‡å¹³å°</label>
      <select id="platform">
        <option value="rk3562">RK3562</option>
        <option value="rk3566">RK3566</option>
        <option value="rk3568">RK3568</option>
        <option value="rk3576" selected>RK3576</option>
        <option value="rk3588">RK3588</option>
      </select>
    </div>
    <div class="fg">
      <label>é‡åŒ–ç±»å‹</label>
      <select id="quantType" onchange="onQuantChange()">
        <option value="i8" selected>INT8ï¼ˆé‡åŒ–ï¼Œæ¨èï¼‰</option>
        <option value="fp">FP16ï¼ˆä¸é‡åŒ–ï¼‰</option>
      </select>
    </div>
  </div>

  <div class="form-row">
    <div class="fg"><label>è¾“å…¥å®½åº¦ (W)</label><input type="number" id="inputWidth" value="640" min="32" max="4096"></div>
    <div class="fg"><label>è¾“å…¥é«˜åº¦ (H)</label><input type="number" id="inputHeight" value="640" min="32" max="4096"></div>
  </div>

  <!-- æ ¡å‡†æ•°æ®é›†é¢æ¿ -->
  <div class="calib-panel missing" id="calibPanel">
    <div class="calib-header" onclick="toggleCalibBody()">
      <div style="display:flex;align-items:center;gap:9px">
        <strong style="font-size:.95em">ğŸ“Š INT8 æ ¡å‡†æ•°æ®é›†</strong>
        <span class="calib-badge missing" id="calibBadge">âš  æœªé…ç½®</span>
      </div>
      <span style="color:#aaa;font-size:.85em" id="calibToggleTip">â–¼ å±•å¼€é…ç½®</span>
    </div>
    <div id="calibBody" class="calib-body">
      <div id="calibReadyInfo" style="display:none;margin-bottom:10px;padding:8px 12px;background:#d4edda;border-radius:6px;color:#155724;font-size:.86em"></div>
      <p style="margin-bottom:10px;color:#666">
        INT8 é‡åŒ–éœ€è¦ä¸€æ‰¹ä»£è¡¨æ€§å›¾ç‰‡ç”¨äºæ ¡å‡†ã€‚è¯·æä¾›è®­ç»ƒæ•°æ®é›†çš„ç›®å½•è·¯å¾„ï¼ˆæœåŠ¡å™¨æœ¬åœ°è·¯å¾„ï¼‰ï¼Œå·¥å…·å°†è‡ªåŠ¨è¯†åˆ«æ ¼å¼å¹¶æå–å›¾ç‰‡ã€‚
      </p>
      <p style="font-size:.82em;color:#888;margin-bottom:10px">
        æ”¯æŒæ ¼å¼ï¼š<strong>æ™®é€šå›¾ç‰‡ç›®å½•</strong>ã€<strong>YOLOï¼ˆå« images/ å­ç›®å½•ï¼‰</strong>ã€<strong>ImageNetï¼ˆç±»åˆ«å­ç›®å½•ï¼‰</strong>ã€<strong>COCOï¼ˆval/train å­ç›®å½•ï¼‰</strong>
      </p>
      <div class="calib-input-row" id="calibInputRow">
        <input type="text" id="calibPath" placeholder="ä¾‹ï¼š/mnt/e/datasets/coco/val2017 æˆ– /home/user/my_dataset">
        <button class="calib-detect-btn" id="calibDetectBtn" onclick="detectDataset()">ğŸ” æ¢æµ‹æ ¼å¼</button>
      </div>
      <div class="calib-status" id="calibDetectStatus"></div>
      <div id="calibConfirmRow" style="display:none;margin-top:10px">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label style="font-size:.85em;font-weight:600;color:#444">æå–æ•°é‡ä¸Šé™</label>
          <input type="number" id="calibMaxImages" value="50" min="10" max="500" style="width:90px">
          <button class="calib-confirm-btn" id="calibConfirmBtn" onclick="prepareCalibration()">âœ… ç¡®è®¤æå–å¹¶ç”Ÿæˆæ ¡å‡†é›†</button>
        </div>
      </div>
      <div class="calib-status" id="calibPrepStatus"></div>
      <p class="calib-help">ğŸ’¡ ä¹Ÿå¯è·³è¿‡ï¼ˆé€‰æ‹© FP16 æ¨¡å¼ï¼‰ï¼Œæˆ–æ‰‹åŠ¨å°†å›¾ç‰‡æ”¾å…¥ <code>calibration_data/&lt;ç±»å‹&gt;/images/</code> ç›®å½•ã€‚</p>
    </div>
  </div>

  <div class="rmsg" id="rmsg"></div>
  <div class="abtn" id="abtn"></div>
  <div class="prog" id="prog"><div class="prog-bar"></div></div>
  <button class="btn btn-primary" id="convertBtn" disabled>é€‰æ‹©æ–‡ä»¶åå¯å¼€å§‹è½¬æ¢</button>
</div>

<!-- å†å² -->
<div class="card">
  <div class="card-title" style="margin-bottom:10px">ğŸ“¦ è½¬æ¢å†å²</div>
  <div id="historyList"><p style="text-align:center;color:#aaa;padding:16px 0">æš‚æ— è½¬æ¢è®°å½•</p></div>
</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let modelTypes = [];
let sel = null;       // selected model type key
let selMeta = null;   // full meta object
let uploadedFile = null;
let validateOk = false;
let calibReady = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  const res = await fetch('/api/model_types');
  const d = await res.json();
  modelTypes = d.model_types;
  renderGrid();
  loadHistory();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Step 1 â€” model type grid
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGrid() {
  document.getElementById('modelGrid').innerHTML = modelTypes.map(t => `
    <div class="mc" data-k="${t.value}" onclick="pickType('${t.value}')">
      <div class="ck">âœ“</div>
      <div class="mci">${t.icon}</div>
      <div class="mcn">${t.short}</div>
      <div class="mcd">${t.description}</div>
      <div class="mcb">${t.accepted_exts.map(e=>'.'+e).join(' / ')}</div>
    </div>`).join('');
}

function pickType(key) {
  sel = key;
  selMeta = modelTypes.find(m => m.value === key);
  document.querySelectorAll('.mc').forEach(c => c.classList.toggle('sel', c.dataset.k === key));
  stepMark(1,'done'); stepMark(2,'active');
  const s2 = document.getElementById('cardStep2');
  s2.style.opacity='1'; s2.style.pointerEvents='';
  document.getElementById('uploadHint').innerHTML = `<strong>${selMeta.icon} ${selMeta.short}</strong>ï¼š${selMeta.hint}`;
  document.getElementById('fileInput').accept = selMeta.accepted_exts.map(e=>'.'+e).join(',');
  document.getElementById('inputWidth').value  = selMeta.input_size_default[0];
  document.getElementById('inputHeight').value = selMeta.input_size_default[1];
  resetUpload();
  checkCalibStatus();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Step 2 â€” file upload + validate
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fileDrop = document.getElementById('fileDrop');
const fileInput = document.getElementById('fileInput');
fileDrop.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => { if(fileInput.files.length) handleFile(fileInput.files[0]); });
fileDrop.addEventListener('dragover', e => { e.preventDefault(); fileDrop.classList.add('dragover'); });
fileDrop.addEventListener('dragleave', () => fileDrop.classList.remove('dragover'));
fileDrop.addEventListener('drop', e => {
  e.preventDefault(); fileDrop.classList.remove('dragover');
  if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});

async function handleFile(file) {
  uploadedFile = file; validateOk = false;
  fileDrop.classList.add('has-file');
  document.getElementById('dropIcon').textContent = 'ğŸ“„';
  document.getElementById('dropMain').innerHTML = `<strong>${file.name}</strong>`;
  document.getElementById('dropSub').textContent = (file.size/1024/1024).toFixed(2)+' MB';
  showVst('checking','â³ æ­£åœ¨æ ¡éªŒæ–‡ä»¶...');
  setBtn(false,'æ ¡éªŒä¸­...');
  const form = new FormData();
  form.append('model_file', file);
  form.append('model_type', sel);
  try {
    const res = await fetch('/api/validate',{method:'POST',body:form});
    const d = await res.json();
    if(d.valid) { validateOk=true; showVst('ok',d.message); activateStep3(); }
    else { validateOk=false; showVst('err',d.message); setBtn(false,'æ–‡ä»¶ä¸åŒ¹é…ï¼Œé‡æ–°é€‰æ‹©'); }
  } catch(e) { showVst('err','æ ¡éªŒå¤±è´¥ï¼š'+e.message); setBtn(false,'æ ¡éªŒå¤±è´¥'); }
}

function showVst(cls,msg){ const e=document.getElementById('vst'); e.className='vst '+cls; e.textContent=msg; }

function activateStep3() {
  const s3=document.getElementById('cardStep3');
  s3.style.opacity='1'; s3.style.pointerEvents='';
  setBtn(true,'ğŸš€ å¼€å§‹è½¬æ¢');
  stepMark(2,'done'); stepMark(3,'active');
}

function resetUpload() {
  uploadedFile=null; validateOk=false;
  fileDrop.classList.remove('has-file');
  fileInput.value='';
  document.getElementById('dropIcon').textContent='ğŸ“';
  document.getElementById('dropMain').textContent='ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½æ¨¡å‹æ–‡ä»¶';
  document.getElementById('dropSub').textContent='æ”¯æŒ .pt / .pth / .onnx';
  document.getElementById('vst').className='vst';
  const s3=document.getElementById('cardStep3');
  s3.style.opacity='.45'; s3.style.pointerEvents='none';
  setBtn(false,'é€‰æ‹©æ–‡ä»¶åå¯å¼€å§‹è½¬æ¢');
  hideRmsg();
  document.getElementById('abtn').className='abtn';
  stepMark(3,'');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Calibration panel
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let calibBodyOpen = true;

function toggleCalibBody() {
  calibBodyOpen = !calibBodyOpen;
  document.getElementById('calibBody').style.display = calibBodyOpen ? '' : 'none';
  document.getElementById('calibToggleTip').textContent = calibBodyOpen ? 'â–² æ”¶èµ·' : 'â–¼ å±•å¼€é…ç½®';
}

async function checkCalibStatus() {
  if(!sel) return;
  const panel = document.getElementById('calibPanel');
  const badge = document.getElementById('calibBadge');
  const readyInfo = document.getElementById('calibReadyInfo');
  try {
    const res = await fetch('/api/calibration/status?model_type='+sel);
    const d = await res.json();
    calibReady = d.ready;
    if(d.ready) {
      panel.className = 'calib-panel ready';
      badge.className = 'calib-badge ready';
      badge.textContent = 'âœ… å·²å°±ç»ªï¼ˆ'+d.count+' å¼ ï¼‰';
      readyInfo.style.display='block';
      readyInfo.textContent = 'âœ… å·²æœ‰ '+d.count+' å¼ æ ¡å‡†å›¾ç‰‡ã€‚å¯ç›´æ¥è½¬æ¢ï¼Œæˆ–é‡æ–°æŒ‡å®šæ•°æ®é›†è¦†ç›–ã€‚';
    } else {
      panel.className = 'calib-panel missing';
      badge.className = 'calib-badge missing';
      badge.textContent = 'âš  æœªé…ç½®';
      readyInfo.style.display='none';
    }
  } catch(e){}
}

async function detectDataset() {
  const path = document.getElementById('calibPath').value.trim();
  if(!path) { alert('è¯·è¾“å…¥æ•°æ®é›†è·¯å¾„'); return; }
  const btn = document.getElementById('calibDetectBtn');
  btn.disabled=true; btn.textContent='æ¢æµ‹ä¸­...';
  const st = document.getElementById('calibDetectStatus');
  st.className='calib-status show info'; st.textContent='â³ æ­£åœ¨æ¢æµ‹è·¯å¾„æ ¼å¼...';
  document.getElementById('calibConfirmRow').style.display='none';
  try {
    const res = await fetch('/api/calibration/detect',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({dataset_path: path})
    });
    const d = await res.json();
    if(d.success) {
      st.className='calib-status show ok';
      st.textContent = 'ğŸ” æ¢æµ‹ç»“æœï¼š'+d.description;
      document.getElementById('calibConfirmRow').style.display='block';
    } else {
      st.className='calib-status show err';
      st.textContent = 'âŒ '+d.description;
    }
  } catch(e) {
    st.className='calib-status show err'; st.textContent='æ¢æµ‹å¤±è´¥ï¼š'+e.message;
  } finally { btn.disabled=false; btn.textContent='ğŸ” æ¢æµ‹æ ¼å¼'; }
}

async function prepareCalibration() {
  const path = document.getElementById('calibPath').value.trim();
  const maxN = parseInt(document.getElementById('calibMaxImages').value)||50;
  const btn = document.getElementById('calibConfirmBtn');
  btn.disabled=true; btn.textContent='æå–ä¸­...';
  const st = document.getElementById('calibPrepStatus');
  st.className='calib-status show info'; st.textContent='â³ æ­£åœ¨æå–å›¾ç‰‡å¹¶ç”Ÿæˆæ ¡å‡†é›†ï¼Œè¯·ç¨å€™...';
  try {
    const res = await fetch('/api/calibration/prepare',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({model_type:sel, dataset_path:path, max_images:maxN})
    });
    const d = await res.json();
    if(d.success) {
      st.className='calib-status show ok'; st.textContent=d.message;
      await checkCalibStatus();
    } else {
      st.className='calib-status show err'; st.textContent='âŒ '+d.message;
    }
  } catch(e) {
    st.className='calib-status show err'; st.textContent='æå–å¤±è´¥ï¼š'+e.message;
  } finally { btn.disabled=false; btn.textContent='âœ… ç¡®è®¤æå–å¹¶ç”Ÿæˆæ ¡å‡†é›†'; }
}

function onQuantChange() {
  const isInt8 = document.getElementById('quantType').value === 'i8';
  document.getElementById('calibPanel').style.display = isInt8 ? '' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Step 3 â€” convert
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('convertBtn').addEventListener('click', doConvert);

async function doConvert() {
  if(!validateOk||!uploadedFile) return;
  hideRmsg();
  document.getElementById('abtn').className='abtn';
  setBtn(false,'<span class="sp"></span>è½¬æ¢ä¸­ï¼Œè¯·ç¨å€™...');
  document.getElementById('prog').classList.add('active');
  const form = new FormData();
  form.append('model_file', uploadedFile);
  form.append('model_type',   sel);
  form.append('platform',     document.getElementById('platform').value);
  form.append('quant_type',   document.getElementById('quantType').value);
  form.append('input_width',  document.getElementById('inputWidth').value);
  form.append('input_height', document.getElementById('inputHeight').value);
  try {
    const res = await fetch('/api/convert',{method:'POST',body:form});
    const d = await res.json();
    document.getElementById('prog').classList.remove('active');
    if(d.success) {
      showRmsg('success','âœ… è½¬æ¢æˆåŠŸï¼<br><pre style="font-size:.82em;margin-top:5px;white-space:pre-wrap">'+d.message+'</pre>');
      const ab=document.getElementById('abtn');
      ab.className='abtn show';
      ab.innerHTML=`<a href="${d.download_url}" class="dlb green">â¬‡ï¸ ä¸‹è½½ RKNN</a>
        <button class="dlb purple" onclick="previewModel('${d.output_file}')">ğŸ‘ Netron é¢„è§ˆ</button>`;
      loadHistory();
    } else {
      showRmsg('error','âŒ è½¬æ¢å¤±è´¥ï¼š<br><pre style="font-size:.82em;margin-top:5px;white-space:pre-wrap">'+d.message+'</pre>');
    }
  } catch(e) {
    document.getElementById('prog').classList.remove('active');
    showRmsg('error','âŒ è¯·æ±‚å¤±è´¥ï¼š'+e.message);
  }
  setBtn(true,'ğŸš€ é‡æ–°è½¬æ¢');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Netron preview
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function previewModel(filename) {
  const btn=event.target; const orig=btn.innerHTML;
  btn.disabled=true; btn.innerHTML='å¯åŠ¨ä¸­...';
  try {
    const res=await fetch('/api/preview',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({filename})});
    const d=await res.json();
    if(d.success) window.open(d.url,'_blank');
    else alert('Netron å¯åŠ¨å¤±è´¥ï¼š'+d.message);
  } catch(e) { alert('Netron å¯åŠ¨å¤±è´¥ï¼š'+e.message); }
  finally { btn.disabled=false; btn.innerHTML=orig; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// History
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadHistory() {
  try {
    const res=await fetch('/api/outputs');
    const d=await res.json();
    const list=document.getElementById('historyList');
    if(d.success&&d.files.length>0) {
      list.innerHTML=d.files.map(f=>`
        <div class="hist-item">
          <div><div class="hist-name">${f.filename}</div><div class="hist-meta">${f.size} Â· ${f.time}</div></div>
          <div class="hist-acts">
            <button class="dlb purple" style="font-size:.8em;padding:6px 13px" onclick="previewModel('${f.filename}')">ğŸ‘ é¢„è§ˆ</button>
            <a href="${f.download_url}" class="dlb green" style="font-size:.8em;padding:6px 13px">â¬‡ï¸ ä¸‹è½½</a>
          </div>
        </div>`).join('');
    } else {
      list.innerHTML='<p style="text-align:center;color:#aaa;padding:16px 0">æš‚æ— è½¬æ¢è®°å½•</p>';
    }
  } catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setBtn(en,html){ const b=document.getElementById('convertBtn'); b.disabled=!en; b.innerHTML=html; }
function showRmsg(cls,html){ const e=document.getElementById('rmsg'); e.className='rmsg show '+cls; e.innerHTML=html; }
function hideRmsg(){ document.getElementById('rmsg').className='rmsg'; }
function stepMark(n,state){
  document.getElementById('st'+n).className='step-item '+state;
  const sep=document.getElementById('sep'+(n-1));
  if(sep) sep.className='step-sep '+(state?'done':'');
}
init();
setInterval(loadHistory,30000);
</script>
</body>
</html>